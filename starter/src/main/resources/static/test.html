<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/antd/4.16.11/antd.min.css" />
    <script src="https://cdn.staticfile.org/react/17.0.2/umd/react.development.js"></script>
    <script src="https://cdn.staticfile.org/react-dom/17.0.2/umd/react-dom.development.js"></script>
    <script src="https://cdn.staticfile.org/babel-standalone/6.26.0/babel.min.js"></script>
    <script src="https://cdn.staticfile.org/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdn.staticfile.org/antd/4.16.11/antd.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.staticfile.org/js-cookie/1.5.0/js.cookie.min.js"></script>
    <script src="./dataGet.ts"></script>
    <style>
        .ant-image-preview-img-wrapper{
            background-color: #80ff82;
        }
        .myMask{
            position: fixed;
            top: 0;
            display: block;
            width: 100%;
            height: 100%;
            left: 0;
            background-color: #032b54de;
            z-index: 1000;
        }
        .imgStream{
            vertical-align: text-top;
        }
        .top{
            position: fixed;
            top: 0;
            left: 0;
            background-color: #86a6ff;
            z-index: 100;
        }
    </style>
</head>
<body>
<div id="ele_panel"></div>
</body>
</html>
<script type="text/babel">

    let tagData = new DateGet();
    tagData.params={
        url:"http://localhost:8081/data/test/allTag",
        dataLocal:"allTag"
    }
    tagData.getData();

    let addTag = new DateGet();
    addTag.params={
        url:"http://localhost:8081/data/test/addTag",
        dataLocal:"addTagResp"
    }

    class TagSelect extends React.Component{
        constructor() {
            super();
            tagData.listener.push(this)
        }

        postData = ()=>{
            if(!this.tagValue || !this.tagValue[0]){
                return ;
            }
            addTag.params.data = {
                stock_code:this.props.stock,
                stock_tag:this.tagValue[0]
            };
            addTag.postData().then((resp)=>{
                tagData.getData();
                return resp;
            }).then(()=>{
                antd.notification.success({description:"标签添加成功"})
            });
        }

        onChange = (value)=>{
            console.log(value);
            this.tagValue=value;
        }
        flush = ()=>{
            this.setState({})
        }

        render() {
            var data = [];
            if (tagData.data){
                data = tagData.data;
            }
            var option = data.map(e=>{
                return <antd.Select.Option value={e.tag}>{e.tag}</antd.Select.Option>
            })
            return (
                <div>
                    <antd.Select mode="tags"  style={{ width: 120 }} onChange={this.onChange}>
                        {option}
                    </antd.Select>
                    <antd.Button onClick={this.postData}>添加标签</antd.Button>
                    <antd.Button>删除标签</antd.Button>
                </div>
            );
        }
    }

    class QueryPanel extends React.Component{
        constructor(props) {
            super(props);
            dataGet.listener.push(this);
        }

        flush = ()=>{
            this.setState({})
        }

        onChange = (v)=>{
            console.log(v)
            dataGet.params.page=0;
            dataGet.params.tag = v;
            dataGet.getData();
        }

        render() {
            let select = <div>
                <antd.Radio.Group onChange={(e)=>{dataGet.imageType = e.target.value;dataGet.flush()}} value={dataGet.imageType}>
                    <antd.Radio value={MIN_TYPE}>时线</antd.Radio>
                    <antd.Radio value={DAILY_TYPE}>日线</antd.Radio>
                    <antd.Radio value={WEEKLY_TYPE}>周线</antd.Radio>
                    <antd.Radio value={MONTHLY_TYPE}>月线</antd.Radio>
                </antd.Radio.Group>
            </div>

            var data = [];
            if (tagData.data){
                data = tagData.data;
            }
            var option = data.map(e=>{
                return <antd.Select.Option value={e.tag}>{e.tag}</antd.Select.Option>
            })
            return (
                <div className="top">
                    {select}
                    <antd.Select allowClear style={{ width: 120 }} onChange={this.onChange}>
                        {option}
                    </antd.Select>
                </div>
            );
        }
    }

    let dataGet = new DateGet();
    dataGet.params={
        url:"http://localhost:8081/data/test/stock2",
        dataLocal:"res",
        page:Number.parseInt(Cookies.get("aa")) || 0,
        pageSize:200
    }
    const MIN_TYPE = 1;
    const DAILY_TYPE = 2;
    const WEEKLY_TYPE = 3;
    const MONTHLY_TYPE = 4;
    dataGet.imageType = DAILY_TYPE;

    class Page extends React.Component{
        constructor() {
            super();
            this.dataGet = dataGet;
        }
        lastPage = () => {
            this.dataGet.params.page = this.dataGet.params.page - this.dataGet.params.pageSize
            if(this.dataGet.params.page < 0){
                this.dataGet.params.page = 0;
            }
            this.dataGet.getData().then(()=>{
                Cookies.set("aa",this.dataGet.params.page)
            });
        }
        nextPage = () => {
            this.dataGet.params.page = this.dataGet.params.page + this.dataGet.params.pageSize
            this.dataGet.getData().then(()=>{
                Cookies.set("aa",this.dataGet.params.page)
            });
        }
        render = () => {
            return <div>
                <span>{this.dataGet.params.page}</span>
                <span>,{this.dataGet.params.pageSize}</span>
                <antd.Button onClick={this.lastPage}>上一页</antd.Button>
                <antd.Button onClick={this.nextPage}>下一页</antd.Button>
            </div>
        }
    }

    class ImageStream extends React.Component{
        constructor() {
            super();
            this.dataGet = dataGet;
            this.dataGet.listener.push(this);
            this.dataGet.getData();
        }
        flush = ()=>{
            console.log("flush:",this.dataGet.imageType)
            this.setState({})
        }
        render = ()=>{
            if(!this.dataGet.data){
                return <div>
                    waiting
                </div>
            }

            let element = this.dataGet.data.map(e=>{
                let pic = "http://image.sinajs.cn/newchart/daily/n/"+e.stock_code+".gif";
                if (this.dataGet.imageType == MIN_TYPE){
                    pic = "http://image.sinajs.cn/newchart/min/n/"+e.stock_code+".gif";
                }
                if (this.dataGet.imageType == DAILY_TYPE){
                    pic = "http://image.sinajs.cn/newchart/daily/n/"+e.stock_code+".gif";
                }
                if (this.dataGet.imageType == WEEKLY_TYPE){
                    pic = "http://image.sinajs.cn/newchart/weekly/n/"+e.stock_code+".gif";
                }
                if (this.dataGet.imageType == MONTHLY_TYPE){
                    pic = "http://image.sinajs.cn/newchart/monthly/n/"+e.stock_code+".gif";
                }
                let key = ""+this.dataGet.imageType+"_"+e.stock_code;
                return <div className="imgStream" key={key} style={{width:300,display:'inline-block',marginBottom:20,borderTop:'1px solid'}}>
                    <antd.Image width="100%"
                                src={pic}
                                preview={{visible:false,onVisibleChange:()=>{
                                antd.Modal.info({
                                    icon:null,
                                    width:"90%",
                                    content:<div>
                                        <img src={"http://image.sinajs.cn/newchart/min/n/"+e.stock_code+".gif"}/>
                                        <img src={"http://image.sinajs.cn/newchart/daily/n/"+e.stock_code+".gif"}/>
                                        <img src={"http://image.sinajs.cn/newchart/weekly/n/"+e.stock_code+".gif"}/>
                                        <img src={"http://image.sinajs.cn/newchart/monthly/n/"+e.stock_code+".gif"}/>
                                    </div>
                                })
                                }}}
                    ></antd.Image>
                    <div style={{textAlign:'center',display:'inline-block'}}>{e.stock_name},{e.stock_code}</div>
                    <a target="_blank" href={"http://quote.eastmoney.com/concept/"+e.stock_code+".html#"} style={{textAlign:'center',display:'inline-block',marginLeft:20}}>东方财富</a>
                    <a target="_blank" href={"https://xueqiu.com/S/"+e.stock_code+""} style={{textAlign:'center',display:'inline-block',marginLeft:20}}>雪球</a>
                    <a target="_blank" href={"http://finance.sina.com.cn/realstock/company/"+e.stock_code+"/nc.shtml"} style={{textAlign:'center',display:'inline-block',marginLeft:20}}>新浪</a>
                    <TagSelect key={e.stock_code} stock={e.stock_code} />
                    <div>{e.tags}</div>

                </div>
            })
            return <div style={{marginTop:60}}>
                {element}
                <Page/>
            </div>
        }
    }
    ReactDOM.render(<div>
        <QueryPanel/>
        <ImageStream/>
    </div>, document.getElementById('ele_panel'));
</script>
<script type="application/javascript">
    function build(ele){
        var arr = null;
        if(ele.children){
            arr = [];
            ele.children.forEach((e)=>{
                arr.push(build(e));
            })
        }
        var a = React.createElement(ele.tag, ele.props,arr);
        console.log(a);
        return a;
    }

    (function buildFromArray(){
        let nodes = $("#J-ajax-main > table > tbody > tr")
        array = array || [];
        nodes.each((i,e)=>{
            var code = $(e).children("td:nth-child(2)").text();
            var tag = code.startsWith("6") ? "sh" : "sz";
            array.push({
                "stock_code":tag+$(e).children("td:nth-child(2)").text(),
                "stock_name":$(e).children("td:nth-child(3)").text(),
            })
        })
        console.log(JSON.stringify(array));
        return array;
    })();

    function a(){
        array = [];
        $("#tableWrap > div.table_templ_box > div > div.static_con_outer > div > table > tbody > tr")
            .each((i,e)=>{
                console.log($(e).find("td:nth-child(3) > div"))
                var code = $(e).find("td:nth-child(3) > div").text();
                var tag = code.startsWith("6") ? "sh" : "sz";
                array.push({
                    "stock_code":tag+code,
                    "stock_name":$(e).find("td:nth-child(4) > div").text(),
                })
            })
        console.log(JSON.stringify(array));
    }

</script>
<script type="application/javascript">

</script>