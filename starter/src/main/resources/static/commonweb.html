<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <!-- import CSS -->
<!--    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">-->
    <link href="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.14/theme-chalk/index.min.css" rel="stylesheet">
    <style type="text/css">

        .custom-tree-node {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            padding-right: 8px;
        }
        .treeItemOp:hover{
            color: #5bb6ff;
        }
        .editor-container>div:first-child{
            height: 500px;
        }
        .beforeI{
            display:block;
            height: 10px;
            background-color: red;
        }
        .redBoard{
            border: 1px solid red;
        }
    </style>
</head>
<body>
<div id="app">
    <h1>可视化页面编辑器</h1>
    <el-row>
        <el-col :span="6">
            <el-tabs value="脚本">
                <el-tab-pane label="标签树" name="first">
                    <div class="grid-content bg-purple">
                        <el-tree
                                :data="treeTag"
                                node-key="id"
                                draggable
                                @node-drag-end="handleDragEnd"
                                :expand-on-click-node="false"
                                @node-click="handleNodeClick"
                                default-expand-all>
                    <span class="custom-tree-node" slot-scope="{ node, data }">
                        <span :class="data.id==editNode.id ? 'redBoard' : ''">{{ data.name || data.tag }}</span>
                        <span>
                            <i class="el-icon-circle-plus treeItemOp" @click="() => append(data)" ></i>
                            <i class="el-icon-remove treeItemOp" @click="() => remove(node, data)"></i>
                        </span>
                    </span>
                        </el-tree>
                    </div>
                </el-tab-pane>
                <el-tab-pane label="数据源" name="second">
                    <span>数据源</span>
                    <div class="editor-container">
                        <monaco-editor
                                v-model="datajson"
                                language="javascript"

                        ></monaco-editor>
                        <el-Button @click="codeFinish">编码完成</el-Button>
                    </div>
                </el-tab-pane>
                <el-tab-pane label="脚本" name="脚本">
                    <div class="editor-container" @click="showSize()" >
                        <monaco-editor
                                v-model="code"
                                language="javascript"
                                :options="editorOptions"
                        ></monaco-editor>
                        <el-Button @click="codeFinish">编码完成</el-Button>
                    </div>

                </el-tab-pane>
            </el-tabs>
        </el-col>
        <el-col :span="15">
            <div class="grid-content bg-purple-light">
                <el-Button @click="refreshOut">刷新</el-Button>
<!--                <my-cc :message="helloMessage"></my-cc>-->
                <component v-bind:is="latestComponentVersion" :message="helloMessage" :editnodeid="editNode.id"></component>
            </div>
        </el-col>
        <el-col :span="3">
            <div class="grid-content bg-purple" v-if="editNode.tag != ''">
                name:<el-input v-model="editNode.name" :placeholder="editNode.tag"></el-input>
                tag:<el-select v-model="editNode.tag" placeholder="请选择">
                        <el-option
                                v-for="item of allEnableTag"
                                :key="item.tag"
                                :label="item.tag"
                                :value="item.tag">
                        </el-option>
                    </el-select>
                content:<el-input v-model="editNode.content"></el-input>
                <hr/>
                <div v-for="item in (allEnableTag[editNode.tag] ? allEnableTag[editNode.tag].props : [])">
                    <span>{{item.name}}</span>
                    <span>{{item.key}}</span>
                    <el-input v-model="editNode.attr[item.key]"></el-input>
                </div>
            </div>
        </el-col>
    </el-row>

</div>
</body>
<script src="https://cdn.bootcdn.net/ajax/libs/axios/1.5.0/axios.min.js"></script>
<!--<script src="https://unpkg.com/vue@2/dist/vue.js"></script>-->
<script src="./js/vue2.0.js"></script>
<!-- import JavaScript -->
<!--<script src="https://unpkg.com/element-ui/lib/index.js"></script>-->
<script src="./js/element.js"></script>
<script src="./js/test.js" ></script>
<script src="./js/commonweb.js" ></script>
<script src="./js/2.vue-editor.js" ></script>
<script src="./js/64.vue-editor.js" ></script>
<script src="./js/vue-editor.js" ></script>
<script>

    Array.prototype.remove = function(b) {
        var a = this.indexOf(b);
        if (a >= 0) {
            this.splice(a, 1);
            return true;
        }
        return false;
    };
    NetUtils = {};
    NetUtils.get = function (url,param){
        return axios.get(url,{params:param}).then(resp=>resp.data)
    }
    NetUtils.post = function (url,param){
        return axios.post(url,param).then(resp=>resp.data)
    }

    let id = 1000;
    let GlobalData = {
        data:{
            name: 'mwy',
            array:[1,2,3,4],
            other:{}
        },
        props: ['message'],
        methods: {
            ccA () {
                alert("cc")
                console.log(this)
            },
            sendMsg(){
                alert("sendMsg");
                this.array.push(++id);
            },
            addOne(){

            },
            didEvent(e,param){
                methodConfig[e].run(param);
            }

        }
    }
    let globalCom = {
        data: function (){
            return GlobalData.data;
        },
        props: ['message'],
        template:"<div v-on:click='ccA'>{{message}} cc</div>",
        methods: GlobalData.methods
    }
    let copyGlobal = JSON.parse(JSON.stringify(globalCom));
    copyGlobal.methods = globalCom.methods;
    Vue.component("my-cc", copyGlobal)


    vue = new Vue({
        el: '#app',
        components: {
            MonacoEditor:MonacoEditor.default
        },
        data: function () {
            return {
                latestComponentVersion:"my-cc",
                visible: false,
                helloMessage: '<div >Hello from MyComponent!</div>',
                treeTag: JSON.parse(localStorage.getItem("treeTagData")) || [{
                    id:1000,
                    name: "根节点",
                    tag:"div",
                    children: [],
                    attr:{}
                }],
                editNode: {},
                allEnableTag:allTags,
                datajson:"{}",
                code:localStorage.getItem("methods") || "",
                editorOptions: {
                    selectOnLineNumbers: true,
                    renderLineHighlight: 'none',
                    readOnly: false,
                    suggestOnTriggerCharacters: true,
                    wordBasedSuggestions: true,
                    wrapperClassName: 'editor-wrapper',
                    className: 'editor-container',
                    automaticLayout: true,
                    glyphMargin: true,
                    lineNumbers: 'on',
                    theme: 'vs-dark'
                },
            }
        },
        mounted(){
            function findMaxId(r){
                for (let item of r) {
                    if (item.id > id){
                        id = item.id;
                        console.log("fixMaxId:"+id)
                    }
                    if (item.children){
                        findMaxId(item.children)
                    }
                }
            }
            findMaxId(this.treeTag);
            let methods = eval(localStorage.getItem("methods"));
            if (methods){
                GlobalData.methods = methods;
            }
        },
        methods: {
            showSize(){
                console.log("size change",event.target.clientWidth)
            },
            handleDragEnd(draggingNode, dropNode, dropType, ev){
                console.log('tree drag end: ', dropNode && dropNode.label, dropType);
            },
            refreshOut(){
                treeRoot = JSON.parse(JSON.stringify(this.treeTag[0]));
                let t =  buildTree(treeRoot);
                let copyGlobal = {}
                copyGlobal.data = function (){return GlobalData.data;};
                copyGlobal.props = ["editnodeid"]
                copyGlobal.methods = GlobalData.methods;
                copyGlobal.template = t;
                // console.log(copyGlobal)
                console.log(copyGlobal.template)
                let cv = "my-cc"+(++id);
                Vue.component(cv, copyGlobal)
                this.helloMessage = ++id;
                this.latestComponentVersion = cv;
                this.saveData();
            },
            append(data) {
                const newChild = {id: ++id, tag: 'div', children: [], attr:{}};
                if (!data.children) {
                    this.$set(data, 'children', []);
                }
                data.children.push(newChild);
                this.refreshOut();
            },
            remove(node, data) {
                if (!this.treeTag || (this.treeTag.length == 1 && this.treeTag[0] == data)){
                    alert("根节点必须有一个")
                    return;
                }
                const parent = node.parent;
                const children = parent.data.children || parent.data;
                const index = children.findIndex(d => d.id === data.id);
                children.splice(index, 1);
                this.refreshOut();
            },
            handleNodeClick(data){
                this.editNode = data;
                console.log(data)
            },
            incrementTotal: function () {
                this.total += 1
                console.log(this.total)
            },
            saveData(){
                localStorage.setItem("treeTagData",JSON.stringify(this.treeTag))
                localStorage.setItem("methods",this.code)
            },
            codeFinish(){
                eval(this.code);
                this.refreshOut();
            }
        },
    })
    function toGString(obj){
        let str = "let $obj={};";
        for (const key in obj) {
            if (obj.hasOwnProperty(key)) {
                str += "$obj." +key + '=';
                const value = obj[key];
                if (typeof value === 'function'){
                    let ts = Function.prototype.toString.call(value);
                    if (ts.startsWith("function")){
                        str += ts;
                    }else str += " function " + ts;
                }else{
                    str += JSON.stringify(value);
                }
                 str += '\n;';
            }
        }
        return str += ";$obj;";
    }
    treeRoot = {
        name: "div",
        children: []
    }

    treeRoot.children.push({
        name: "el-Button",
        children: [{name: 'txt', content: "xxx"}]
    })

    function buildTree(root) {
        l = "";
        if (root.tag == 'txt') {
            l+=`<span :class="${root.id}==editnodeid ? 'redBoard' : ''">${root.content}</span>`
        }else if (root.selfTag === true) {
            let attr = " ";
            if (root.attr){
                for (let item in root.attr) {
                    attr += item + "="+ root.attr[item]+" ";
                }
            }
            l += `<${root.tag} ${attr} :class="${root.id}==editnodeid ? 'redBoard' : ''"/>`
        } else {
            let attr = " ";
            if (root.attr){
                for (let item in root.attr) {
                    attr += item + "="+ root.attr[item]+" ";
                }
            }
            l += `<${root.tag} ${attr} :class="${root.id}==editnodeid ? 'redBoard' : ''">`
            if (root.children) {
                for (let i = 0; i < root.children.length; i++) {
                    l += buildTree(root.children[i])
                }
            }
            l += `</${root.tag}>`
        }
        return l;
    }


</script>
</html>