<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <!-- import CSS -->
    <!--    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">-->
    <link href="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.14/theme-chalk/index.min.css" rel="stylesheet">
    <style type="text/css">

        .custom-tree-node {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            padding-right: 8px;
        }
        .treeItemOp:hover{
            color: #5bb6ff;
        }
        .editor-container>div:first-child{
            height: 500px;
        }
        .myEditor{
            height: 500px;
        }
        .beforeI{
            display:block;
            height: 10px;
            background-color: red;
        }
        .redBoard{
            border: 1px solid red;
        }
    </style>
</head>
<body>
<div id="app">
    <component v-if="latestComponentVersion !=''" v-bind:is="latestComponentVersion" :message="helloMessage" :editnodeid="editNode.id"></component>
</div>
</body>
<script src="https://cdn.bootcdn.net/ajax/libs/axios/1.5.0/axios.min.js"></script>
<!--<script src="https://unpkg.com/vue@2/dist/vue.js"></script>-->
<script src="./js/vue2.0.js"></script>
<!-- import JavaScript -->
<!--<script src="https://unpkg.com/element-ui/lib/index.js"></script>-->
<script src="./js/element.js"></script>
<script src="./js/test.js" ></script>
<script src="./js/commonweb.js" ></script>
<script src="./js/2.vue-editor.js" ></script>
<script src="./js/64.vue-editor.js" ></script>
<script src="./js/vue-editor.js" ></script>
<script>

    Array.prototype.remove = function(b) {
        var a = this.indexOf(b);
        if (a >= 0) {
            this.splice(a, 1);
            return true;
        }
        return false;
    };
    NetUtils = {};
    NetUtils.get = function (url,param){
        return axios.get(url,{params:param}).then(resp=>resp.data)
    }
    NetUtils.post = function (url,param){
        return axios.post(url,param).then(resp=>resp.data)
    }

    let id = 1000;
    let GlobalData = {
        data:{
            configData:{},
            name: 'mwy',
            array:[1,2,3,4],
            other:{}
        },
        props: ['message'],
        methods: {
        }
    }
    let globalCom = {
        data: function (){
            return GlobalData.data;
        },
        props: ['message'],
        methods: GlobalData.methods
    }

    vue = new Vue({
        el: '#app',
        components: {
        },
        data: function () {
            return {

                latestComponentVersion:"",
                helloMessage: '<div >Hello from MyComponent!</div>',
                treeTag: JSON.parse(localStorage.getItem("treeTagData")) || [{
                    id:1000,
                    name: "根节点",
                    tag:"div",
                    children: [],
                    attr:{}
                }],
                editNode: {},
                dataConfigJson:localStorage.getItem("dataConfigJson") || "{}",
                code:localStorage.getItem("methods") || "",
            }
        },
        mounted(){

            let methods = eval(localStorage.getItem("methods"));
            if (methods){
                GlobalData.methods = methods;
            }
            eval("GlobalData.data.configData="+this.dataConfigJson);
            this.refreshOut();
        },
        computed:{

        },
        methods: {
            refreshOut(){
                treeRoot = JSON.parse(JSON.stringify(this.treeTag[0]));
                let t =  buildTree(treeRoot);
                let copyGlobal = {}
                copyGlobal.data = function (){return GlobalData.data;};
                copyGlobal.props = ["editnodeid"]
                copyGlobal.methods = GlobalData.methods;
                copyGlobal.template = t;
                // console.log(copyGlobal)
                console.log(copyGlobal.template)
                let cv = "my-cc"+(++id);
                Vue.component(cv, copyGlobal)
                this.helloMessage = ++id;
                this.latestComponentVersion = cv;
            }
        },
    })
    treeRoot = {
        name: "div",
        children: []
    }

    function buildTree(root) {
        l = "";
        if (root.tag == 'txt') {
            l+=`<span :class="${root.id}==editnodeid ? 'redBoard' : ''">${root.content}</span>`
        }else if (root.selfTag === true) {
            let attr = " ";
            if (root.attr){
                for (let item in root.attr) {
                    attr += item + "="+ root.attr[item]+" ";
                }
            }
            l += `<${root.tag} ${attr} :class="${root.id}==editnodeid ? 'redBoard' : ''"/>`
        } else {
            let attr = " ";
            if (root.attr){
                for (let item in root.attr) {
                    if (root.attr[item] !== undefined && root.attr[item] !== ''){
                        attr += item + "="+ root.attr[item]+" ";
                    }
                }
            }
            l += `<${root.tag} ${attr} :class="${root.id}==editnodeid ? 'redBoard' : ''">`
            if (root.children) {
                for (let i = 0; i < root.children.length; i++) {
                    l += buildTree(root.children[i])
                }
            }
            l += `</${root.tag}>`
        }
        return l;
    }


</script>
</html>